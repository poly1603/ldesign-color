"use strict";/*!
 * ***********************************
 * @ldesign/color v1.0.0           *
 * Built with rollup               *
 * Build time: 2024-10-21 14:32:31 *
 * Build mode: production          *
 * Minified: No                    *
 * ***********************************
 */var l=require("../palette/cssVariables.cjs"),c=require("../palette/darkMode.cjs");require("../core/Color.cjs"),require("../core/conversions.cjs");var a=require("./presets.cjs");const y="ldesign-theme",u="ld";class m{constructor(e={}){this.currentTheme=null,this.listeners=new Set,this.themeHistory=[],this.maxHistorySize=5,this.themeRegistry=new Map,this.destroyed=!1,this.themeCache=new Map,this.storageKey=e.storageKey||y,this.prefix=e.prefix||u,this.loadThemeRegistry(),e.autoApply!==!1&&this.restore()}applyTheme(e,t={}){let r=e,s;const i=a.getPresetTheme(e);i&&(r=i.color,s=i.name);const o=c.generateThemePalettes(r,{preserveInput:!0});return l.injectThemedCssVariables(o,!0),this.currentTheme={primaryColor:r,themeName:s,prefix:t.prefix||this.prefix,createdAt:this.currentTheme?.createdAt||Date.now(),updatedAt:Date.now(),version:this.currentTheme?.version||"1.0.0"},this.addToHistory(this.currentTheme),this.save(this.currentTheme),this.notifyListeners(this.currentTheme),this.currentTheme}applyPresetTheme(e,t={}){if(!a.getPresetTheme(e))throw new Error(`Preset theme "${e}" not found`);return this.applyTheme(e,t)}getCurrentTheme(){return this.currentTheme}exportTheme(){if(!this.currentTheme)throw new Error("No theme to export");return JSON.stringify(this.currentTheme,null,2)}importTheme(e){try{const t=typeof e=="string"?JSON.parse(e):e;if(!t.primaryColor)throw new Error("Invalid theme data: primaryColor is required");return this.applyTheme(t.primaryColor,{prefix:t.prefix})}catch(t){throw new Error(`Failed to import theme: ${t.message}`)}}detectSystemTheme(){return typeof window<"u"&&window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}watchSystemTheme(e){return this.cleanupSystemThemeWatcher(),typeof window<"u"&&window.matchMedia?(this.systemThemeMediaQuery=window.matchMedia("(prefers-color-scheme: dark)"),this.systemThemeHandler=t=>{this.destroyed||e(t.matches?"dark":"light")},this.systemThemeMediaQuery.addEventListener("change",this.systemThemeHandler),()=>{this.cleanupSystemThemeWatcher()}):()=>{}}cleanupSystemThemeWatcher(){this.systemThemeMediaQuery&&this.systemThemeHandler&&(this.systemThemeMediaQuery.removeEventListener("change",this.systemThemeHandler),this.systemThemeHandler=void 0)}downloadTheme(e="theme.json"){if(typeof window>"u"||!this.currentTheme)throw new Error("Cannot download theme in non-browser environment or no theme set");const t=new Blob([this.exportTheme()],{type:"application/json"}),r=URL.createObjectURL(t),s=document.createElement("a");try{s.href=r,s.download=e,s.style.display="none",document.body.appendChild(s),s.click()}finally{setTimeout(()=>{document.body.removeChild(s),URL.revokeObjectURL(r)},100)}}save(e){if(typeof window<"u"&&window.localStorage)try{localStorage.setItem(this.storageKey,JSON.stringify(e))}catch(t){console.error("Failed to save theme:",t)}}restore(){if(typeof window<"u"&&window.localStorage)try{const e=localStorage.getItem(this.storageKey);if(e){const t=JSON.parse(e);return this.applyTheme(t.themeName||t.primaryColor,{prefix:t.prefix}),t}}catch(e){console.error("Failed to restore theme:",e)}return null}clear(){if(typeof window<"u"&&window.localStorage)try{localStorage.removeItem(this.storageKey),this.currentTheme=null}catch(e){console.error("Failed to clear theme:",e)}}onChange(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}notifyListeners(e){this.listeners.forEach(t=>t(e))}getPresets(){return a.presetThemes}createChildTheme(e,t,r){const s=this.getTheme(e);if(!s)throw new Error(`Parent theme "${e}" not found`);const i={...s,...r,themeName:t,parent:e,version:"1.0.0",createdAt:Date.now(),updatedAt:Date.now()};return this.registerTheme(t,i),i}getTheme(e){const t=this.themeCache.get(e);if(t)return t;if(this.themeRegistry.has(e)){const s=this.themeRegistry.get(e);if(s)return this.themeCache.set(e,s),s}const r=a.getPresetTheme(e);if(r){const s={primaryColor:r.color,themeName:r.name,version:"1.0.0"};return this.themeCache.set(e,s),s}}registerTheme(e,t){if(this.themeRegistry.size>=50&&!this.themeRegistry.has(e)){const r=this.themeRegistry.keys().next().value;r&&(this.themeRegistry.delete(r),this.themeCache.delete(r))}this.themeRegistry.set(e,t),this.saveThemeRegistry()}saveThemeRegistry(){if(typeof window<"u"&&window.localStorage)try{const e=Array.from(this.themeRegistry.entries());localStorage.setItem(`${this.storageKey}-registry`,JSON.stringify(e))}catch(e){console.error("Failed to save theme registry:",e)}}loadThemeRegistry(){if(typeof window<"u"&&window.localStorage)try{const e=localStorage.getItem(`${this.storageKey}-registry`);if(e){const t=JSON.parse(e);this.themeRegistry=new Map(t)}}catch(e){console.error("Failed to load theme registry:",e)}}updateThemeVersion(e,t){const r=this.getTheme(e);if(!r)throw new Error(`Theme "${e}" not found`);r.version=t,r.updatedAt=Date.now(),this.currentTheme?.themeName===e&&(this.currentTheme=r,this.save(this.currentTheme)),this.registerTheme(e,r)}addToHistory(e){const t=this.themeHistory[0];if(t&&t.primaryColor===e.primaryColor)return;const r={primaryColor:e.primaryColor,themeName:e.themeName,isDark:e.isDark,updatedAt:e.updatedAt};for(this.themeHistory.unshift(r);this.themeHistory.length>this.maxHistorySize;)this.themeHistory.pop()}getThemeHistory(){return[...this.themeHistory]}rollbackTheme(e=1){if(e>=this.themeHistory.length)return console.warn("Cannot rollback beyond history limit"),null;const t=this.themeHistory[e];return t?this.applyTheme(t.themeName||t.primaryColor):null}async enableAIIntegration(e){if(!this.destroyed&&!this.aiIntegration)try{const{ColorAI:t}=await Promise.resolve().then(function(){return require("../ai/colorAI.cjs")});this.aiIntegration=new t({apiKey:e})}catch(t){console.error("Failed to enable AI integration:",t)}}async getAISuggestions(e){return this.aiIntegration||await this.enableAIIntegration(),this.aiIntegration?this.aiIntegration.getSuggestions(e||{mood:["professional","modern"],industry:"technology"}):[]}async applyAISuggestedTheme(e,t=0){const r=await this.getAISuggestions(e);if(r&&r.length>t){const s=r[t].colors[0].toHex();return this.applyTheme(s,{prefix:this.prefix})}return null}compareThemes(e,t){const r=this.getTheme(e),s=this.getTheme(t);if(!r||!s)throw new Error("One or both themes not found");const i=[];let o=0;return r.primaryColor!==s.primaryColor?i.push(`Primary color: ${r.primaryColor} vs ${s.primaryColor}`):o++,r.isDark!==s.isDark?i.push(`Dark mode: ${r.isDark} vs ${s.isDark}`):o++,r.prefix!==s.prefix?i.push(`Prefix: ${r.prefix} vs ${s.prefix}`):o++,r.parent!==s.parent?i.push(`Parent theme: ${r.parent} vs ${s.parent}`):o++,r.version!==s.version?i.push(`Version: ${r.version} vs ${s.version}`):o++,{differences:i,similarity:o/5*100}}exportAllThemes(){const e={current:this.currentTheme,history:this.themeHistory,registry:Array.from(this.themeRegistry.entries())};return JSON.stringify(e,null,2)}importAllThemes(e){try{const t=JSON.parse(e);t.registry&&(this.themeCache.clear(),this.themeRegistry=new Map(t.registry),this.saveThemeRegistry()),t.history&&(this.themeHistory=t.history.slice(0,this.maxHistorySize)),t.current&&this.applyTheme(t.current.themeName||t.current.primaryColor)}catch(t){throw new Error(`Failed to import themes: ${t.message}`)}}destroy(){this.destroyed=!0,this.cleanupSystemThemeWatcher(),this.listeners.clear(),this.aiIntegration&&typeof this.aiIntegration.destroy=="function"&&this.aiIntegration.destroy(),this.aiIntegration=void 0,this.themeHistory.length=0,this.themeRegistry.clear(),this.themeCache.clear(),this.currentTheme=null}}const h=new m;typeof window<"u"&&window.addEventListener("beforeunload",()=>{h.destroy()},{once:!0});function d(n,e){return h.applyTheme(n,e)}function p(n,e){return h.applyPresetTheme(n,e)}function g(){return h.restore()}function T(){return h.getCurrentTheme()}exports.ThemeManager=m,exports.applyPresetTheme=p,exports.applyTheme=d,exports.defaultThemeManager=h,exports.getCurrentTheme=T,exports.restoreTheme=g;/*! End of @ldesign/color | Powered by @ldesign/builder */
//# sourceMappingURL=themeManager.cjs.map
