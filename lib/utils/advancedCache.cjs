"use strict";/*!
 * ***********************************
 * @ldesign/color v1.0.0           *
 * Built with rollup               *
 * Build time: 2024-10-21 14:32:31 *
 * Build mode: production          *
 * Minified: No                    *
 * ***********************************
 */class n{constructor(e=100,t="LRU",s){this.persistTimer=null,this.isDirty=!1,this.persistDelay=5e3,this.cache=new Map,this.maxSize=e,this.strategy=t,this.stats={hits:0,misses:0},this.persistKey=s,s&&this.restore()}get(e){const t=this.cache.get(e);if(t)return this.stats.hits++,t.frequency++,t.lastAccess=Date.now(),this.strategy==="LRU"&&(this.cache.delete(e),this.cache.set(e,t)),t.value;this.stats.misses++}set(e,t){const s=Date.now();this.cache.size>=this.maxSize&&!this.cache.has(e)&&this.evict();const i=this.cache.get(e),r={value:t,frequency:i?i.frequency+1:1,lastAccess:s,createdAt:i?i.createdAt:s};this.cache.set(e,r),this.persistKey&&(this.isDirty=!0,this.schedulePersist())}schedulePersist(){this.persistTimer!==null&&clearTimeout(this.persistTimer),this.persistTimer=(typeof window<"u"?window.setTimeout:setTimeout)(()=>{if(this.isDirty){if(typeof window<"u"&&"requestIdleCallback"in window)window.requestIdleCallback(()=>{try{this.persist()}catch(e){console.warn("Cache persist failed:",e)}},{timeout:1e3});else try{this.persist()}catch(e){console.warn("Cache persist failed:",e)}this.isDirty=!1}this.persistTimer=null},this.persistDelay)}evict(){let e;switch(this.strategy){case"LFU":{let t=1/0,s=1/0;for(const[i,r]of this.cache.entries())(r.frequency<t||r.frequency===t&&r.lastAccess<s)&&(t=r.frequency,s=r.lastAccess,e=i);break}case"FIFO":{let t=1/0;for(const[s,i]of this.cache.entries())i.createdAt<t&&(t=i.createdAt,e=s);break}case"LRU":default:e=this.cache.keys().next().value;break}e&&this.cache.delete(e)}has(e){return this.cache.has(e)}delete(e){return this.cache.delete(e)}clear(){this.cache.clear(),this.stats={hits:0,misses:0}}get size(){return this.cache.size}getStats(){const e=this.stats.hits+this.stats.misses;return{hits:this.stats.hits,misses:this.stats.misses,hitRate:e>0?this.stats.hits/e:0,size:this.cache.size,maxSize:this.maxSize,utilization:this.cache.size/this.maxSize*100}}prewarm(e){for(const{key:t,value:s}of e)this.set(t,s)}persist(){if(!(!this.persistKey||typeof window>"u"))try{const e=this.getMostFrequent(20).map(({key:s})=>{const i=this.cache.get(s);return{key:s,value:i.value,frequency:i.frequency,lastAccess:i.lastAccess,createdAt:i.createdAt}}),t=JSON.stringify({data:e,stats:this.stats,strategy:this.strategy,timestamp:Date.now()});if(t.length>512*1024){console.warn("Cache data too large, skipping persist");return}localStorage.setItem(this.persistKey,t)}catch(e){typeof process<"u"&&process.env.NODE_ENV==="development"&&console.warn("Failed to persist cache:",e)}}restore(){if(!(!this.persistKey||typeof window>"u"))try{const e=localStorage.getItem(this.persistKey);if(!e)return;const{data:t,stats:s,timestamp:i}=JSON.parse(e);if(Date.now()-i>7200*1e3){localStorage.removeItem(this.persistKey);return}this.cache.clear();for(const{key:r,value:c,frequency:h,lastAccess:u,createdAt:y}of t)this.cache.set(r,{value:c,frequency:h,lastAccess:u,createdAt:y});this.stats=s}catch(e){console.error("Failed to restore cache:",e)}}getMostFrequent(e=10){return Array.from(this.cache.entries()).sort((t,s)=>s[1].frequency-t[1].frequency).slice(0,e).map(([t,s])=>({key:t,value:s.value,frequency:s.frequency}))}optimize(){const e=Array.from(this.cache.values()).map(s=>s.frequency),t=e.reduce((s,i)=>s+i,0)/e.length*.5;for(const[s,i]of this.cache.entries())i.frequency<t&&this.cache.delete(s)}setStrategy(e){this.strategy=e}snapshot(){return Array.from(this.cache.entries()).map(([e,t])=>({key:e,value:t.value}))}destroy(){this.persistTimer!==null&&(clearTimeout(this.persistTimer),this.persistTimer=null),this.isDirty&&this.persistKey&&(this.persist(),this.isDirty=!1),this.clear()}}const o=new n(100,"LFU","ldesign-color-cache");typeof window<"u"&&(window.addEventListener("beforeunload",()=>{o.destroy()},{once:!0}),document.addEventListener("visibilitychange",()=>{document.hidden&&o.optimize()}));const l=new WeakMap;function d(a,e){let t=l.get(a);t||(t=new n(e?.maxSize||20,e?.strategy||"LRU"),l.set(a,t));const s=(...i)=>{const r=e?.getKey?e.getKey(...i):JSON.stringify(i),c=t.get(r);if(c!==void 0)return c;const h=a(...i);return t.set(r,h),h};return s.clearCache=()=>{t.clear()},s.destroyCache=()=>{t.destroy(),l.delete(a)},s}function f(...a){return a.map(e=>e===null?"null":e===void 0?"undefined":typeof e=="object"?JSON.stringify(e):String(e)).join("-")}exports.AdvancedColorCache=n,exports.createCacheKey=f,exports.globalColorCache=o,exports.memoize=d;/*! End of @ldesign/color | Powered by @ldesign/builder */
//# sourceMappingURL=advancedCache.cjs.map
